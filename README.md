# VK test task
Тестовое задание для vk. Рабочая версия доступна по http://46.101.97.235

## Что кешируется
 - Индивидуальные позиции: id -> item. Сбрасываются на delete/edit.
 - Количество элементов в базе: () -> count. Increment/decrement на add/remove.
 - Страницы: (sort_column, sort_direction, page_number, version) -> list(id). Сбрасываются по таймауту. Старые значения не читаются после продвижения версии.

## Стратегия кеширования
Любой запрос к базе проходит через кеш:
1. вычислить cache_key от запроса
2. запросить в кеше
3. если кеш вернул результат - return
4. вычислить cache_lock_key от cache_key
5. выставить в кеше по cache_lock_key в true cas'ом с небольшим таймаутом
6. если не получилось немного подождать и перейти к 2, получилось - к 7
7. сделать запрос к бд
8. сохранить результат в кеш
9. сбросить значение по cache_lock_key в кеше

### Кеширование страниц
Страница читается в 3 этапа: 
1. получить версию
2. получить все list(id) элементов из страницы
3. получить данные всех элементов по id

Версия хранится в кеше отдельным полем и продвигается на каждый add/remove/edit
После продвижения версии старый кеш страниц удалится по таймауту

Ключ состоит из сортировки, номера страницы и версии.
```php
$cache_key = "PAGING[$sort_column,$sort_direction,$page,$version]";
```
Страницы достаются большими порциями, по n элементов c ключем
```php
$bucket = intdiv($page, $n)
$cache_lock_key = "PAGING_LOCK[$sort_column,$sort_direction,$bucket,$version]";
```
n - большое число. Скажем 500. Тогда на любой update для каждой сортировки нужно будет достать из базы и положить в кеш 
```
500 страниц * 50 элементов на страницу * 4 байта на id ~ 100кб
```
